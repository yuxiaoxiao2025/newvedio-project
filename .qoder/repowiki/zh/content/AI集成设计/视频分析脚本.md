# 视频分析脚本系统文档

<cite>
**本文档引用的文件**
- [video_analyzer.py](file://backend/scripts/video_analyzer.py)
- [video_analyzer.py](file://backend/src/scripts/video_analyzer.py)
- [aiController.js](file://backend/src/controllers/aiController.js)
- [aiService.js](file://backend/src/services/aiService.js)
- [useAIAnalysis.js](file://frontend/src/composables/useAIAnalysis.js)
- [ai.js](file://backend/src/routes/ai.js)
- [upload.js](file://backend/src/config/upload.js)
- [analysisStorage.js](file://frontend/src/utils/analysisStorage.js)
- [ContentAnalysisView.vue](file://frontend/src/components/ContentAnalysisView.vue)
- [FusionAnalysisView.vue](file://frontend/src/components/FusionAnalysisView.vue)
- [MusicPromptView.vue](file://frontend/src/components/MusicPromptView.vue)
- [API.md](file://backend/API.md)
- [API_DOCS.md](file://backend/API_DOCS.md)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [核心组件分析](#核心组件分析)
4. [视频分析流程](#视频分析流程)
5. [前后端交互](#前后端交互)
6. [数据存储与管理](#数据存储与管理)
7. [性能优化](#性能优化)
8. [故障排除指南](#故障排除指南)
9. [总结](#总结)

## 项目概述

这是一个基于人工智能的视频分析系统，集成了阿里云DashScope多模态AI服务，提供视频内容分析、视频融合分析和背景音乐提示词生成等功能。系统采用前后端分离架构，支持实时进度跟踪和多种分析模式。

### 主要功能特性

- **视频内容分析**：深度视频内容理解，提取关键帧、场景、物体和动作信息
- **视频融合分析**：智能融合方案设计，支持双视频融合规划
- **音乐提示词生成**：基于视频内容生成专业的AI音乐创作提示词
- **实时进度跟踪**：WebSocket实现实时分析进度反馈
- **多格式支持**：支持MP4、AVI等主流视频格式
- **云端与本地结合**：结合DashScope API和本地Python SDK的优势

## 系统架构

```mermaid
graph TB
subgraph "前端层"
UI[Vue.js 用户界面]
Composable[useAIAnalysis Composable]
Storage[本地存储管理]
end
subgraph "后端服务层"
Router[Express 路由]
Controller[AI控制器]
Service[AI服务]
Python[Python分析脚本]
end
subgraph "AI服务层"
DashScope[DashScope API]
LocalSDK[本地Python SDK]
end
subgraph "存储层"
LocalStorage[浏览器本地存储]
FileSystem[文件系统]
end
UI --> Composable
Composable --> Router
Router --> Controller
Controller --> Service
Service --> DashScope
Service --> Python
Python --> LocalSDK
Composable --> Storage
Storage --> LocalStorage
Service --> FileSystem
```

**架构图来源**
- [aiController.js](file://backend/src/controllers/aiController.js#L1-L348)
- [aiService.js](file://backend/src/services/aiService.js#L1-L800)
- [useAIAnalysis.js](file://frontend/src/composables/useAIAnalysis.js#L1-L530)

## 核心组件分析

### 后端AI服务架构

系统采用双模型协同架构，充分利用DashScope的多模态AI能力：

```mermaid
classDiagram
class AIService {
+apiKey : string
+baseURL : string
+timeout : number
+analyzeVideoContent(videoPath, prompt) Promise
+analyzeVideoWithSDK(videoPath, type, prompt, videoPath2) Promise
+generateVideoReport(analysisData, type, stream) Promise
+analyzeVideoThreeStage(videoPath, io, sessionId) Promise
+analyzeFusionThreeStage(video1Path, video2Path, io, sessionId) Promise
}
class AIController {
+aiService : AIService
+analyzeVideo(req, res) Promise
+analyzeFusion(req, res) Promise
+generateMusicPrompt(req, res) Promise
+analyzeUploadedFile(req, res) Promise
+getAnalysisStatus(req, res) Promise
}
class VideoAnalyzerPython {
+analyze_video_with_sdk(video_path, analysis_type, extra_prompt, video_path2) JSON
+load_env() void
+main() void
}
AIService --> VideoAnalyzerPython : "调用本地SDK"
AIController --> AIService : "依赖"
AIService --> DashScope : "调用API"
```

**类图来源**
- [aiService.js](file://backend/src/services/aiService.js#L10-L800)
- [aiController.js](file://backend/src/controllers/aiController.js#L6-L348)
- [video_analyzer.py](file://backend/scripts/video_analyzer.py#L43-L395)

### 前端分析组件架构

```mermaid
classDiagram
class UseAIAnalysis {
+isAnalyzing : Ref~boolean~
+analysisProgress : Ref~number~
+analysisResult : Ref~object~
+error : Ref~string~
+analyzeVideoContent(videoData) Promise
+analyzeVideoFusion(video1Data, video2Data) Promise
+generateMusicPrompt(fusionPlan) Promise
+analyzeUploadedFiles(files, category, analysisType) Promise
}
class ContentAnalysisView {
+summary : object
+keyframes : Array
+scenes : Array
+activeTab : string
+formatDuration(duration) string
+getSceneDistribution() Array
+getContentSegments() Array
}
class FusionAnalysisView {
+video1Summary : object
+video2Summary : object
+compatibility : object
+fusionPlan : object
+getVideoSegments(source) Array
+getFusionSegments() Array
+formatPlan(plan) string
}
class MusicPromptView {
+prompt : string
+copyToClipboard() Promise
+downloadPrompt() void
}
UseAIAnalysis --> ContentAnalysisView : "提供数据"
UseAIAnalysis --> FusionAnalysisView : "提供数据"
UseAIAnalysis --> MusicPromptView : "提供数据"
```

**类图来源**
- [useAIAnalysis.js](file://frontend/src/composables/useAIAnalysis.js#L14-L530)
- [ContentAnalysisView.vue](file://frontend/src/components/ContentAnalysisView.vue#L1-L200)
- [FusionAnalysisView.vue](file://frontend/src/components/FusionAnalysisView.vue#L1-L200)
- [MusicPromptView.vue](file://frontend/src/components/MusicPromptView.vue#L1-L200)

**章节来源**
- [aiService.js](file://backend/src/services/aiService.js#L1-L800)
- [aiController.js](file://backend/src/controllers/aiController.js#L1-L348)
- [useAIAnalysis.js](file://frontend/src/composables/useAIAnalysis.js#L1-L530)

## 视频分析流程

### 三阶段分析流程

系统采用三阶段处理流程，确保分析质量和可靠性：

```mermaid
sequenceDiagram
participant Client as 前端客户端
participant Controller as AI控制器
participant Service as AI服务
participant Python as Python SDK
participant DashScope as DashScope API
Client->>Controller : 发起分析请求
Controller->>Service : analyzeVideoThreeStage()
Note over Service : 阶段1 : 视频理解分析
Service->>Python : analyzeVideoWithSDK()
Python->>Python : 本地文件分析
Python-->>Service : 分析结果
Service->>Controller : 发送进度更新
Controller->>Client : WebSocket通知
Note over Service : 阶段2 : 数据结构化
Service->>Service : structureVideoData()
Service->>Controller : 发送进度更新
Note over Service : 阶段3 : 生成报告
Service->>DashScope : generateVideoReport()
DashScope-->>Service : 专业报告
Service-->>Controller : 完整分析结果
Controller-->>Client : 返回最终结果
```

**序列图来源**
- [aiService.js](file://backend/src/services/aiService.js#L667-L785)
- [aiController.js](file://backend/src/controllers/aiController.js#L14-L90)

### 视频融合分析流程

```mermaid
flowchart TD
Start([开始融合分析]) --> LoadVideos["加载两个视频文件"]
LoadVideos --> ValidateFiles["验证文件有效性"]
ValidateFiles --> ExtractFeatures["提取视频特征"]
ExtractFeatures --> CompareContent["内容对比分析"]
CompareContent --> CheckCompatibility{"检查兼容性"}
CheckCompatibility --> |兼容| DesignPlan["设计融合方案"]
CheckCompatibility --> |不兼容| SuggestImprovements["提供建议"]
DesignPlan --> CreateTimeline["创建时间轴"]
CreateTimeline --> OptimizeSegments["优化分段策略"]
OptimizeSegments --> GenerateTransitions["生成转场效果"]
GenerateTransitions --> FinalReview["最终方案审查"]
SuggestImprovements --> FinalReview
FinalReview --> GenerateReport["生成融合报告"]
GenerateReport --> End([分析完成])
```

**流程图来源**
- [aiService.js](file://backend/src/services/aiService.js#L789-L800)
- [aiController.js](file://backend/src/controllers/aiController.js#L95-L182)

**章节来源**
- [aiService.js](file://backend/src/services/aiService.js#L667-L800)
- [aiController.js](file://backend/src/controllers/aiController.js#L14-L182)

## 前后端交互

### API接口设计

系统提供了完整的RESTful API接口，支持多种分析模式：

| 接口路径 | 方法 | 功能描述 | 请求参数 |
|---------|------|----------|----------|
| `/api/ai/analyze/content` | POST | 视频内容分析 | videoPath, category, sessionId |
| `/api/ai/analyze/fusion` | POST | 视频融合分析 | video1Path, video2Path, category, sessionId |
| `/api/ai/generate/music-prompt` | POST | 音乐提示词生成 | fusionPlan |
| `/api/ai/analyze/upload` | POST | 上传文件分析 | files, category, analysisType |
| `/api/ai/analysis/{id}/status` | GET | 分析状态查询 | analysisId |

### WebSocket实时通信

系统使用Socket.io实现实时进度跟踪：

```mermaid
sequenceDiagram
participant Frontend as 前端组件
participant Backend as 后端服务
participant WebSocket as WebSocket连接
Frontend->>Backend : 发起分析请求
Backend->>WebSocket : 建立会话连接
WebSocket-->>Frontend : 连接确认
loop 分析过程
Backend->>WebSocket : 发送进度更新
WebSocket-->>Frontend : 实时进度通知
end
Backend->>WebSocket : 分析完成通知
WebSocket-->>Frontend : 完成状态
Frontend->>Backend : 查询最终结果
```

**序列图来源**
- [useAIAnalysis.js](file://frontend/src/composables/useAIAnalysis.js#L32-L135)
- [aiController.js](file://backend/src/controllers/aiController.js#L62-L74)

**章节来源**
- [ai.js](file://backend/src/routes/ai.js#L1-L54)
- [API.md](file://backend/API.md#L1-L337)
- [API_DOCS.md](file://backend/API_DOCS.md#L1-L437)

## 数据存储与管理

### 本地存储架构

系统采用多层次存储策略，确保数据的可靠性和性能：

```mermaid
graph TB
subgraph "前端存储层"
LocalStorage[浏览器LocalStorage]
IndexedDB[IndexedDB数据库]
end
subgraph "内存缓存层"
MemoryCache[内存缓存]
SessionStorage[会话存储]
end
subgraph "分析数据结构"
ContentResult[内容分析结果]
FusionResult[融合分析结果]
MusicResult[音乐提示词]
History[分析历史]
end
LocalStorage --> MemoryCache
IndexedDB --> MemoryCache
MemoryCache --> ContentResult
MemoryCache --> FusionResult
MemoryCache --> MusicResult
MemoryCache --> History
```

**图表来源**
- [analysisStorage.js](file://frontend/src/utils/analysisStorage.js#L36-L534)

### 数据结构定义

系统定义了严格的数据结构来确保数据一致性：

| 数据类型 | 结构描述 | 存储键名 | 生命周期 |
|---------|----------|----------|----------|
| 内容分析结果 | 视频分析原始数据+结构化数据+报告 | `ai_analysis_results` | 7天 |
| 融合分析结果 | 双视频分析+融合方案 | `ai_analysis_results` | 7天 |
| 音乐提示词 | AI音乐创作提示词 | `ai_analysis_results` | 7天 |
| 分析历史 | 会话历史记录 | `ai_analysis_history` | 7天 |

**章节来源**
- [analysisStorage.js](file://frontend/src/utils/analysisStorage.js#L1-L534)

## 性能优化

### 并发处理机制

系统实现了多种性能优化策略：

1. **异步处理**：所有AI分析任务都采用异步处理
2. **超时控制**：设置合理的超时时间防止长时间等待
3. **重试机制**：自动重试失败的API调用
4. **缓存策略**：智能缓存常用分析结果
5. **资源限制**：文件大小和数量限制

### 内存管理

```mermaid
flowchart TD
Request[接收分析请求] --> ValidateMemory["验证可用内存"]
ValidateMemory --> CheckCache["检查缓存大小"]
CheckCache --> CleanOld["清理旧数据"]
CleanOld --> ProcessAnalysis["执行分析"]
ProcessAnalysis --> StoreResult["存储结果"]
StoreResult --> UpdateStats["更新统计"]
UpdateStats --> Complete[完成]
ValidateMemory --> |内存不足| ClearCache["清理缓存"]
ClearCache --> ProcessAnalysis
```

**流程图来源**
- [analysisStorage.js](file://frontend/src/utils/analysisStorage.js#L443-L476)

## 故障排除指南

### 常见问题及解决方案

| 问题类型 | 症状描述 | 可能原因 | 解决方案 |
|---------|----------|----------|----------|
| API调用失败 | 分析请求超时 | 网络连接问题/DashScope服务异常 | 检查网络连接，使用降级模式 |
| 文件上传失败 | 上传进度卡住 | 文件过大/格式不支持 | 检查文件格式和大小限制 |
| 分析结果为空 | 返回空数据 | 视频文件损坏/格式不支持 | 验证视频文件完整性 |
| WebSocket连接失败 | 实时进度无更新 | 网络防火墙/代理问题 | 检查网络配置 |

### 错误处理机制

系统实现了完善的错误处理机制：

```mermaid
flowchart TD
Error[捕获错误] --> ClassifyError["错误分类"]
ClassifyError --> NetworkError{"网络错误?"}
ClassifyError --> ValidationError{"验证错误?"}
ClassifyError --> BusinessError{"业务错误?"}
NetworkError --> |是| RetryLogic["重试逻辑"]
ValidationError --> |是| UserFeedback["用户反馈"]
BusinessError --> |是| GracefulDegradation["优雅降级"]
RetryLogic --> MaxRetries{"达到最大重试?"}
MaxRetries --> |否| WaitAndRetry["等待重试"]
MaxRetries --> |是| FallbackMode["降级模式"]
WaitAndRetry --> Error
FallbackMode --> LogError["记录错误"]
UserFeedback --> LogError
GracefulDegradation --> LogError
LogError --> End[结束]
```

**章节来源**
- [aiService.js](file://backend/src/services/aiService.js#L199-L202)
- [aiController.js](file://backend/src/controllers/aiController.js#L76-L89)

## 总结

该视频分析脚本系统是一个功能完整、架构合理的人工智能视频分析解决方案。系统通过前后端分离架构、双模型协同处理、实时进度跟踪等技术手段，提供了高质量的视频分析服务。

### 主要优势

1. **技术先进性**：集成最新的AI多模态技术
2. **用户体验**：实时进度跟踪和直观的可视化展示
3. **可靠性**：完善的错误处理和降级机制
4. **扩展性**：模块化设计便于功能扩展
5. **性能优化**：多层次缓存和并发处理

### 应用前景

该系统可广泛应用于视频内容审核、媒体制作、教育培训、广告创意等多个领域，为用户提供智能化的视频分析解决方案。
# 后端架构文档

<cite>
**本文档引用的文件**
- [app.js](file://backend/src/app.js)
- [ai.js](file://backend/src/routes/ai.js)
- [upload.js](file://backend/src/routes/upload.js)
- [auth.js](file://backend/src/middleware/auth.js)
- [upload.js](file://backend/src/middleware/upload.js)
- [aiController.js](file://backend/src/controllers/aiController.js)
- [uploadController.js](file://backend/src/controllers/uploadController.js)
- [aiService.js](file://backend/src/services/aiService.js)
- [uploadService.js](file://backend/src/services/uploadService.js)
- [upload.js](file://backend/src/config/upload.js)
- [logger.js](file://backend/src/utils/logger.js)
- [package.json](file://backend/package.json)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [系统架构总览](#系统架构总览)
3. [应用入口与初始化](#应用入口与初始化)
4. [路由层架构](#路由层架构)
5. [中间件层设计](#中间件层设计)
6. [控制器层实现](#控制器层实现)
7. [服务层架构](#服务层架构)
8. [配置管理](#配置管理)
9. [日志系统](#日志系统)
10. [WebSocket实时通信](#websocket实时通信)
11. [请求处理流程](#请求处理流程)
12. [性能与安全考虑](#性能与安全考虑)
13. [总结](#总结)

## 项目概述

本项目是一个基于Express.js的视频上传与AI分析后端系统，采用经典的MVC架构模式。系统提供了完整的视频文件上传、存储、管理和AI智能分析功能，支持多种视频格式的深度分析和融合处理。

### 核心特性
- **多阶段AI分析**：结合阿里云通义千问模型进行视频内容理解和报告生成
- **实时文件上传**：支持大文件分块上传和进度监控
- **WebSocket实时通信**：提供实时上传进度反馈
- **多用户会话管理**：支持并发上传和状态跟踪
- **安全的身份验证**：基于中间件的访问控制机制

## 系统架构总览

```mermaid
graph TB
subgraph "客户端层"
WebUI[Web界面]
MobileApp[移动端应用]
end
subgraph "网络层"
CDN[CDN加速]
LB[负载均衡器]
end
subgraph "应用层"
Express[Express.js服务器]
SocketIO[Socket.IO实时通信]
end
subgraph "路由层"
AIRoutes[AI分析路由]
UploadRoutes[文件上传路由]
end
subgraph "中间件层"
AuthMW[身份验证中间件]
UploadMW[文件上传中间件]
LoggerMW[日志中间件]
ErrorMW[错误处理中间件]
end
subgraph "控制器层"
AIController[AI控制器]
UploadController[上传控制器]
end
subgraph "服务层"
AIService[AI服务]
UploadService[上传服务]
end
subgraph "数据层"
FileSystem[文件系统存储]
MemoryStore[内存会话存储]
LogFiles[日志文件]
end
WebUI --> CDN
MobileApp --> CDN
CDN --> LB
LB --> Express
Express --> SocketIO
Express --> AIRoutes
Express --> UploadRoutes
AIRoutes --> AuthMW
UploadRoutes --> AuthMW
UploadRoutes --> UploadMW
AuthMW --> AIController
UploadMW --> UploadController
AIController --> AIService
UploadController --> UploadService
AIService --> FileSystem
UploadService --> FileSystem
UploadService --> MemoryStore
Express --> LoggerMW
Express --> ErrorMW
LoggerMW --> LogFiles
```

**架构图来源**
- [app.js](file://backend/src/app.js#L19-L166)
- [ai.js](file://backend/src/routes/ai.js#L1-L71)
- [upload.js](file://backend/src/routes/upload.js#L1-L62)

## 应用入口与初始化

### 应用启动流程

应用入口文件`app.js`负责整个系统的初始化和配置，采用模块化的设计模式。

```mermaid
sequenceDiagram
participant Main as "app.js主程序"
participant Express as "Express实例"
participant Middleware as "中间件栈"
participant Routes as "路由注册"
participant Services as "服务初始化"
participant Server as "HTTP服务器"
Main->>Express : 创建Express应用实例
Main->>Middleware : 注册全局中间件
Note over Middleware : Helmet, Compression, CORS
Main->>Middleware : 配置速率限制
Main->>Middleware : 设置Body解析
Main->>Middleware : 添加请求日志
Main->>Routes : 注册API路由
Main->>Services : 初始化服务实例
Main->>Server : 启动HTTP服务器
Server-->>Main : 服务就绪通知
```

**序列图来源**
- [app.js](file://backend/src/app.js#L37-L166)

### 中间件加载顺序

系统中间件按照以下顺序加载和执行：

1. **安全中间件** (`helmet`, `compression`)
2. **跨域中间件** (`cors`)
3. **速率限制** (`rateLimit`)
4. **请求解析** (`express.json`, `express.urlencoded`)
5. **日志记录** (`logger`)
6. **路由处理** (`routes`)
7. **错误处理** (`errorHandler`)
8. **404处理** (`notFoundHandler`)

**节来源**
- [app.js](file://backend/src/app.js#L37-L111)

## 路由层架构

### 路由组织结构

系统采用模块化的路由设计，将不同的功能模块分离到独立的路由文件中。

```mermaid
graph LR
subgraph "路由层结构"
RootRouter[根路由器]
subgraph "AI分析路由 (/api/ai)"
ContentAnalysis[内容分析]
FusionAnalysis[融合分析]
MusicPrompt[音乐提示词]
UploadAnalysis[上传分析]
StatusQuery[状态查询]
end
subgraph "文件上传路由 (/api/upload)"
SessionCreate[创建会话]
FileUpload[批量上传]
ProgressQuery[进度查询]
SessionCancel[取消会话]
FileDelete[删除文件]
FileValidate[文件验证]
end
end
RootRouter --> AIAnalysis
RootRouter --> UploadAnalysis
AIAnalysis --> ContentAnalysis
AIAnalysis --> FusionAnalysis
AIAnalysis --> MusicPrompt
AIAnalysis --> UploadAnalysis
AIAnalysis --> StatusQuery
UploadAnalysis --> SessionCreate
UploadAnalysis --> FileUpload
UploadAnalysis --> ProgressQuery
UploadAnalysis --> SessionCancel
UploadAnalysis --> FileDelete
UploadAnalysis --> FileValidate
```

**架构图来源**
- [ai.js](file://backend/src/routes/ai.js#L1-L71)
- [upload.js](file://backend/src/routes/upload.js#L1-L62)

### AI分析路由详解

AI分析路由提供了完整的视频智能分析功能：

| 路由路径 | HTTP方法 | 功能描述 | 认证要求 |
|---------|----------|----------|----------|
| `/api/ai/analyze/content` | POST | 视频内容深度分析 | 是 |
| `/api/ai/analyze/fusion` | POST | 视频融合分析 | 是 |
| `/api/ai/generate/music-prompt` | POST | 背景音乐提示词生成 | 是 |
| `/api/ai/analyze/upload` | POST | 一体化上传分析 | 是 |
| `/api/ai/analysis/:analysisId/status` | GET | 分析状态查询 | 是 |

**节来源**
- [ai.js](file://backend/src/routes/ai.js#L31-L69)

### 文件上传路由详解

文件上传路由支持完整的文件生命周期管理：

| 路由路径 | HTTP方法 | 功能描述 | 认证要求 |
|---------|----------|----------|----------|
| `/api/upload/session` | POST | 创建上传会话 | 是 |
| `/api/upload/batch` | POST | 批量文件上传 | 是 |
| `/api/upload/progress/:sessionId` | GET | 查询上传进度 | 是 |
| `/api/upload/cancel/:sessionId` | POST | 取消上传会话 | 是 |
| `/api/upload/file/:fileId` | DELETE | 删除文件 | 是 |
| `/api/upload/validate` | POST | 文件格式验证 | 否 |

**节来源**
- [upload.js](file://backend/src/routes/upload.js#L46-L61)

## 中间件层设计

### 身份验证中间件

身份验证中间件提供基础的访问控制功能，目前处于开发阶段，未来将集成JWT令牌验证。

```mermaid
flowchart TD
Request[HTTP请求] --> AuthMW[身份验证中间件]
AuthMW --> DevMode{开发模式?}
DevMode --> |是| MockUser[设置模拟用户]
DevMode --> |否| TokenCheck[令牌验证]
MockUser --> NextMW[下一个中间件]
TokenCheck --> ValidToken{令牌有效?}
ValidToken --> |是| SetUser[设置用户信息]
ValidToken --> |否| AuthError[认证失败]
SetUser --> NextMW
AuthError --> ErrorResponse[返回401错误]
NextMW --> Controller[控制器处理]
```

**流程图来源**
- [auth.js](file://backend/src/middleware/auth.js#L4-L15)

### 文件上传中间件

文件上传中间件基于Multer实现，提供强大的文件处理和验证功能。

```mermaid
flowchart TD
FileUpload[文件上传请求] --> MulterConfig[Multer配置]
MulterConfig --> FileFilter[文件过滤器]
FileFilter --> SizeCheck{文件大小检查}
SizeCheck --> |超限| SizeError[文件过大错误]
SizeCheck --> |通过| TypeCheck{文件类型检查}
TypeCheck --> |不支持| TypeError[不支持的格式错误]
TypeCheck --> |通过| Storage[存储配置]
Storage --> TempSave[临时保存]
TempSave --> Success[上传成功]
SizeError --> ErrorHandler[错误处理器]
TypeError --> ErrorHandler
ErrorHandler --> ErrorResponse[返回错误响应]
```

**流程图来源**
- [upload.js](file://backend/src/middleware/upload.js#L25-L44)

### 错误处理中间件

系统实现了完善的错误处理机制，包括Multer错误处理和通用错误处理。

**节来源**
- [auth.js](file://backend/src/middleware/auth.js#L1-36)
- [upload.js](file://backend/src/middleware/upload.js#L56-L109)

## 控制器层实现

### AI控制器架构

AI控制器负责处理所有的AI相关请求，作为Express路由和AI服务之间的桥梁。

```mermaid
classDiagram
class AIController {
-aiService : AIService
+analyzeVideo(req, res) : Promise~void~
+analyzeFusion(req, res) : Promise~void~
+generateMusicPrompt(req, res) : Promise~void~
+analyzeUploadedFile(req, res) : Promise~void~
+getAnalysisStatus(req, res) : Promise~void~
}
class AIService {
-vlClient : OpenAI
-textClient : OpenAI
+analyzeVideoContent(videoPath, prompt) : Promise~Object~
+generateVideoReport(analysisData, reportType) : Promise~String~
+analyzeVideoThreeStage(videoPath) : Promise~Object~
+analyzeFusionThreeStage(video1Path, video2Path) : Promise~Object~
+callWithRetry(serviceFunction, maxRetries) : Promise~any~
}
AIController --> AIService : "使用"
```

**类图来源**
- [aiController.js](file://backend/src/controllers/aiController.js#L5-L237)
- [aiService.js](file://backend/src/services/aiService.js#L8-L672)

### 上传控制器架构

上传控制器管理文件的完整生命周期，包括会话创建、文件上传、进度监控等功能。

```mermaid
classDiagram
class UploadController {
+validateFiles(req, res) : Promise~void~
+createSession(req, res) : Promise~void~
+uploadFiles(req, res) : Promise~void~
+getProgress(req, res) : Promise~void~
+cancelUpload(req, res) : Promise~void~
+deleteFile(req, res) : Promise~void~
}
class UploadService {
-io : SocketIO
+validateFiles(files) : Promise~Object~
+createSession(category, expectedFiles) : Promise~Object~
+uploadFiles(sessionId, category, files) : Promise~Object~
+getProgress(sessionId) : Promise~Object~
+cancelUpload(sessionId) : Promise~Object~
+deleteFile(fileId) : Promise~Object~
+emitProgress(sessionId, data) : void
}
UploadController --> UploadService : "使用"
```

**类图来源**
- [uploadController.js](file://backend/src/controllers/uploadController.js#L25-L285)
- [uploadService.js](file://backend/src/services/uploadService.js#L12-L416)

### 请求处理模式

控制器采用统一的错误处理模式，确保所有异常都能被正确捕获和响应。

**节来源**
- [aiController.js](file://backend/src/controllers/aiController.js#L13-L237)
- [uploadController.js](file://backend/src/controllers/uploadController.js#L27-L285)

## 服务层架构

### AI服务设计

AI服务层封装了与阿里云AI模型的交互细节，采用双模型协同架构：

```mermaid
graph TB
subgraph "AI服务架构"
AIService[AI服务实例]
subgraph "模型客户端"
VLClient[qwen-vl-plus客户端]
TextClient[qwen-plus客户端]
end
subgraph "分析流程"
Stage1[阶段1: 视频理解分析]
Stage2[阶段2: 数据结构化]
Stage3[阶段3: 报告生成]
end
subgraph "AI模型"
QwenVL[qwen-vl模型]
QwenText[qwen-plus模型]
end
end
AIService --> VLClient
AIService --> TextClient
VLClient --> QwenVL
TextClient --> QwenText
AIService --> Stage1
Stage1 --> Stage2
Stage2 --> Stage3
```

**架构图来源**
- [aiService.js](file://backend/src/services/aiService.js#L8-L19)

### 三阶段分析流程

AI服务实现了创新的三阶段处理流程，确保高质量的分析结果：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "控制器"
participant AIService as "AI服务"
participant VLModel as "VL模型"
participant TextModel as "文本模型"
Client->>Controller : 发送分析请求
Controller->>AIService : 调用三阶段分析
AIService->>VLModel : 阶段1 : 视频理解分析
VLModel-->>AIService : 返回原始分析结果
AIService->>AIService : 阶段2 : 数据结构化处理
AIService->>TextModel : 阶段3 : 生成专业报告
TextModel-->>AIService : 返回最终报告
AIService-->>Controller : 返回完整分析结果
Controller-->>Client : 返回分析结果
```

**序列图来源**
- [aiService.js](file://backend/src/services/aiService.js#L420-L474)

### 重试机制设计

AI服务实现了基于指数退避的智能重试机制，提高服务的可靠性：

| 重试次数 | 延迟时间 | 说明 |
|---------|----------|------|
| 1 | 1秒 | 第一次重试 |
| 2 | 2秒 | 第二次重试 |
| 3 | 4秒 | 第三次重试 |
| 最大 | 8秒 | 达到最大重试次数 |

**节来源**
- [aiService.js](file://backend/src/services/aiService.js#L614-L672)

### 上传服务设计

上传服务提供了完整的文件管理功能，支持实时进度监控和并发处理。

```mermaid
stateDiagram-v2
[*] --> Pending : 创建会话
Pending --> Uploading : 开始上传
Uploading --> Completed : 上传完成
Uploading --> Failed : 上传失败
Uploading --> Cancelled : 用户取消
Completed --> [*]
Failed --> [*]
Cancelled --> [*]
note right of Uploading : 实时进度更新<br/>WebSocket推送
```

**状态图来源**
- [uploadService.js](file://backend/src/services/uploadService.js#L118-L295)

**节来源**
- [aiService.js](file://backend/src/services/aiService.js#L1-672)
- [uploadService.js](file://backend/src/services/uploadService.js#L1-416)

## 配置管理

### 配置文件结构

系统采用集中式的配置管理，所有配置项都集中在`upload.js`配置文件中。

```mermaid
graph TB
subgraph "配置层次"
Config[upload.js配置]
subgraph "服务器配置"
Port[端口设置]
MaxFileSize[文件大小限制]
MaxFiles[最大文件数]
end
subgraph "文件类型"
MimeTypes[MIME类型列表]
Extensions[文件扩展名]
Categories[文件分类]
end
subgraph "安全配置"
RateLimit[速率限制]
SessionTimeout[会话超时]
CleanupInterval[清理间隔]
end
subgraph "命名规则"
FileNameGen[文件命名策略]
PathConfig[目录路径配置]
end
end
Config --> Port
Config --> MaxFileSize
Config --> MaxFiles
Config --> MimeTypes
Config --> Extensions
Config --> Categories
Config --> RateLimit
Config --> SessionTimeout
Config --> CleanupInterval
Config --> FileNameGen
Config --> PathConfig
```

**架构图来源**
- [upload.js](file://backend/src/config/upload.js#L3-L53)

### 环境变量支持

系统支持通过环境变量覆盖默认配置，便于不同环境的部署：

| 配置项 | 默认值 | 环境变量 | 说明 |
|-------|--------|----------|------|
| 端口 | 8005 | PORT | HTTP服务器端口 |
| 最大文件大小 | 300MB | MAX_FILE_SIZE | 单个文件最大尺寸 |
| 最大文件数 | 3 | MAX_FILES_PER_SESSION | 单次会话最大文件数 |
| 会话超时 | 24小时 | - | 上传会话有效期 |
| 清理间隔 | 1小时 | - | 会话清理周期 |

**节来源**
- [upload.js](file://backend/src/config/upload.js#L1-53)

## 日志系统

### 日志架构设计

系统采用Winston日志库实现结构化日志记录，支持多级别和多传输。

```mermaid
graph LR
subgraph "日志系统"
Logger[日志记录器]
subgraph "日志级别"
Info[信息日志]
Debug[调试日志]
Error[错误日志]
User[用户日志]
Dev[开发者日志]
end
subgraph "传输目标"
Console[控制台输出]
ErrorFile[错误日志文件]
CombinedFile[综合日志文件]
end
end
Logger --> Info
Logger --> Debug
Logger --> Error
Logger --> User
Logger --> Dev
Logger --> Console
Logger --> ErrorFile
Logger --> CombinedFile
```

**架构图来源**
- [logger.js](file://backend/src/utils/logger.js#L18-L66)

### 日志级别说明

| 日志级别 | 方法名 | 使用场景 | 输出目标 |
|---------|--------|----------|----------|
| info | logger.info() | 一般信息记录 | 控制台+文件 |
| debug | logger.debug() | 开发调试信息 | 控制台+文件 |
| error | logger.error() | 错误信息记录 | 错误文件 |
| user | logger.user() | 用户友好消息 | 综合文件 |
| dev | logger.dev() | 开发者技术信息 | 综合文件 |

**节来源**
- [logger.js](file://backend/src/utils/logger.js#L1-66)

## WebSocket实时通信

### 实时通信架构

系统集成了Socket.IO实现实时通信功能，主要用于文件上传进度的实时反馈。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Server as "服务器"
participant UploadService as "上传服务"
participant Session as "会话管理"
Client->>Server : 建立WebSocket连接
Server-->>Client : 连接确认
Client->>Server : 加入上传会话
Server->>Session : 创建会话标识
Session-->>Server : 返回会话ID
Server-->>Client : 确认加入会话
loop 文件上传过程
Server->>UploadService : 开始文件上传
UploadService->>UploadService : 更新上传进度
UploadService->>Server : 推送进度更新
Server->>Client : 发送实时进度
end
Server->>Client : 上传完成通知
Client->>Server : 离开会话
Server->>Session : 清理会话资源
```

**序列图来源**
- [app.js](file://backend/src/app.js#L113-L130)

### 会话管理机制

WebSocket会话采用房间系统进行隔离管理：

```mermaid
graph TB
subgraph "WebSocket会话管理"
IO[Socket.IO实例]
subgraph "连接管理"
Connect[客户端连接]
JoinRoom[加入房间]
LeaveRoom[离开房间]
Disconnect[断开连接]
end
subgraph "房间系统"
SessionRoom[会话房间]
ProgressBroadcast[进度广播]
end
end
IO --> Connect
Connect --> JoinRoom
JoinRoom --> SessionRoom
SessionRoom --> ProgressBroadcast
ProgressBroadcast --> LeaveRoom
LeaveRoom --> Disconnect
```

**架构图来源**
- [app.js](file://backend/src/app.js#L113-L130)

**节来源**
- [app.js](file://backend/src/app.js#L113-L130)

## 请求处理流程

### 完整请求处理链路

从HTTP请求接收到AI分析结果返回的完整流程展示了MVC架构的实际运作。

```mermaid
flowchart TD
Request[HTTP请求] --> Express[Express服务器]
Express --> CORS[CORS中间件]
CORS --> RateLimit[速率限制]
RateLimit --> BodyParser[请求体解析]
BodyParser --> Auth[身份验证]
Auth --> Route{路由分发}
Route --> |AI分析| AIRoutes[AI路由]
Route --> |文件上传| UploadRoutes[上传路由]
AIRoutes --> AIAuth[AI认证]
UploadRoutes --> UploadAuth[上传认证]
AIAuth --> AIController[AI控制器]
UploadAuth --> UploadController[上传控制器]
AIController --> AIService[AI服务]
UploadController --> UploadService[上传服务]
AIService --> AIClients[AI模型客户端]
UploadService --> FileSystem[文件系统]
UploadService --> Sessions[会话存储]
AIClients --> AIResponse[AI响应]
FileSystem --> UploadResponse[上传响应]
Sessions --> ProgressUpdate[进度更新]
AIResponse --> Response[HTTP响应]
UploadResponse --> Response
ProgressUpdate --> WebSocket[WebSocket推送]
Response --> Client[客户端]
WebSocket --> Client
```

**流程图来源**
- [app.js](file://backend/src/app.js#L84-L111)
- [ai.js](file://backend/src/routes/ai.js#L31-L69)
- [upload.js](file://backend/src/routes/upload.js#L46-L61)

### 错误处理流程

系统实现了多层次的错误处理机制，确保用户体验和系统稳定性。

```mermaid
flowchart TD
Error[错误发生] --> ErrorType{错误类型}
ErrorType --> |路由错误| NotFound[404 Not Found]
ErrorType --> |认证错误| AuthError[401 Unauthorized]
ErrorType --> |业务错误| BusinessError[400 Bad Request]
ErrorType --> |系统错误| SystemError[500 Internal Server Error]
ErrorType --> |Multer错误| MulterError[Multer错误处理]
NotFound --> LogError[记录错误日志]
AuthError --> LogError
BusinessError --> LogError
SystemError --> LogError
MulterError --> LogError
LogError --> ErrorResponse[构建错误响应]
ErrorResponse --> Client[返回客户端]
```

**流程图来源**
- [app.js](file://backend/src/app.js#L92-L111)

## 性能与安全考虑

### 性能优化策略

1. **中间件优化**
   - 使用`compression`中间件压缩响应
   - 启用`helmet`提供安全头部
   - 实施速率限制防止滥用

2. **文件处理优化**
   - 支持大文件分块上传
   - 实现文件上传进度实时反馈
   - 采用内存缓存减少磁盘I/O

3. **AI服务优化**
   - 实现智能重试机制
   - 采用双模型协同处理
   - 支持流式响应处理

### 安全防护措施

1. **输入验证**
   - 文件类型和大小验证
   - MIME类型检查
   - 文件内容扫描

2. **访问控制**
   - 基于中间件的身份验证
   - 文件操作权限控制
   - 会话超时管理

3. **网络安全**
   - CORS配置限制
   - HTTPS强制使用
   - 请求频率限制

**节来源**
- [app.js](file://backend/src/app.js#L37-L58)
- [upload.js](file://backend/src/middleware/upload.js#L25-L44)

## 总结

本项目展示了基于Express.js的完整MVC架构实现，具有以下特点：

### 架构优势
- **模块化设计**：清晰的分层架构便于维护和扩展
- **服务解耦**：控制器与服务层完全分离，提高代码复用性
- **中间件机制**：灵活的中间件系统支持各种横切关注点
- **实时通信**：WebSocket集成提供优秀的用户体验

### 技术亮点
- **AI集成**：深度集成阿里云AI模型，实现智能化视频分析
- **文件管理**：完整的文件生命周期管理，支持并发和进度监控
- **错误处理**：完善的错误处理和重试机制，确保系统稳定性
- **日志系统**：结构化日志记录，便于问题诊断和性能监控

### 扩展性考虑
- **配置管理**：集中式配置支持多环境部署
- **服务抽象**：良好的服务接口设计便于替换底层实现
- **监控集成**：内置日志和健康检查机制
- **测试支持**：完整的单元测试和集成测试覆盖

该架构为视频分析和文件管理应用提供了坚实的技术基础，具备良好的可维护性和扩展性，能够满足企业级应用的需求。
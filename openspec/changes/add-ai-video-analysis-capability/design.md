## AI模型协同架构设计

### 背景
基于实践验证，单独使用VL模型处理复杂的报告生成和背景音乐提示词创作任务时，面临较大难度，无法达到预期质量标准。需要引入文本模型qwen-plus进行协同处理。

### 目标 / 非目标

**目标：**
- 建立VL模型与文本模型的有效协同机制
- 确保视频内容分析的准确性和报告生成的丰富度
- 提供高质量的背景音乐生成提示词
- 优化模型调用成本和响应时间

**非目标：**
- 实时视频流分析（当前仅支持文件上传）
- 复杂的多模态推理任务
- 实时音视频合成

### 决策

**决策1：双模型协同架构**
- **qwen3-vl-plus/max**：负责视频内容理解和基础分析
- **qwen-plus**：负责结构化报告生成和创意文案创作
- **理由**：VL模型擅长视觉理解，文本模型擅长逻辑表达和创意写作

**决策2：三阶段处理流程**
- **阶段1**：VL模型提取视频关键信息（帧、场景、动作）
- **阶段2**：信息结构化处理和数据转换
- **阶段3**：qwen-plus生成最终报告和提示词

**替代方案考虑：**
- 单一VL模型处理所有任务：质量不达标，已验证不可行
- 使用更强大的VL模型：成本过高，仍存在文本生成限制
- 多模型并行调用：架构复杂，收益不明显

### 模型调用流程

#### 1. 视频内容分析流程
```python
# 阶段1：视频理解（VL模型）
vl_analysis = qwen3_vl_analyze(video_file, prompt="""
#背景# 分析上传的视频文件
#目的# 提取视频的基本信息和关键内容要素
#任务步骤# 1. 识别视频时长 2. 提取关键帧 3. 分析场景变化 4. 检测主要物体 5. 识别动作序列
#输出# JSON格式：{duration: 秒, keyframes: [时间戳, 描述], scenes: [类型, 时间段], objects: [名称, 出现时间], actions: [动作, 时间段]}
""")

# 阶段3：报告生成（qwen-plus）
final_report = qwen_plus_generate(prompt=f"""
#背景# 视频内容原始分析数据：{vl_analysis}
#目的# 生成专业的视频内容分析报告
#风格# 专业视频分析师，数据驱动，客观准确
#受众# 视频制作专业人士
#输出# 结构化报告，包含：时长分析、关键帧解读、场景分类、物体检测、动作识别、情感基调、色彩分析、质量评估
#任务步骤#
1. 分析视频时长特征和节奏
2. 详细解读每个关键帧的视觉元素
3. 对场景进行专业分类和分析
4. 列出检测到的物体及其意义
5. 分析动作序列的逻辑性
6. 评估整体情感基调
7. 分析色彩分布和视觉效果
8. 综合评估画面质量
""")
```

#### 2. 视频融合方案流程
```python
# 阶段1：双视频分析（VL模型）
video1_analysis = qwen3_vl_analyze(video1_file, analysis_prompt)
video2_analysis = qwen3_vl_analyze(video2_file, analysis_prompt)

# 阶段3：融合方案设计（qwen-plus）
fusion_plan = qwen_plus_generate(prompt=f"""
#背景# 视频A分析：{video1_analysis}；视频B分析：{video2_analysis}
#目的# 设计30-50秒融合视频的完整制作方案
#风格# 专业视频剪辑师，注重叙事逻辑和视觉效果
#受众# 视频制作团队
#输出# 详细融合方案，包含：
1. 最优分段策略（精确到秒级时间戳）
2. 关键画面裁剪建议（构图、焦点）
3. 转场效果选择（3种以上方案）
4. 音频处理建议（音量、音效）
5. 画面融合技术参数（分辨率、编码）
6. 整体叙事逻辑说明
7. 时间轴可视化图表描述
#任务步骤#
1. 分析两个视频的内容特点和互补性
2. 设计时间轴结构，确定最佳分段点
3. 选择合适的转场效果并说明理由
4. 制定音频处理策略
5. 确定技术参数和质量标准
6. 设计叙事逻辑和情感曲线
7. 生成可视化时间轴描述
""")
```

#### 3. 背景音乐提示词流程
```python
# 阶段3：音乐提示词生成（qwen-plus）
music_prompt = qwen_plus_generate(prompt=f"""
#背景# 视频融合方案：{fusion_plan}
#目的# 生成专业级背景音乐创作提示词
#风格# 音乐制作人和影视配乐专家
#受众# AI音乐生成模型
#输出# 详细音乐创作提示词，包含：
1. 音乐风格定位（基于视频情感基调）
2. 情感曲线设计（随时间变化的情绪变化）
3. 节奏与画面匹配方案（具体时间点的节奏要求）
4. 乐器选择建议（适合场景和情感的乐器组合）
5. 时长控制参数（与视频精确匹配）
6. 关键转场处的音乐变化指示
7. 整体氛围描述（营造的听觉环境）
#任务步骤#
1. 分析融合视频的情感基调和叙事结构
2. 设计音乐风格和整体氛围
3. 规划情感曲线和节奏变化
4. 选择合适的乐器组合
5. 设计关键转场点的音乐变化
6. 确定技术参数和制作要求
7. 生成完整的创作提示词
""")
```

### 数据交互方式

#### API调用规范
- **统一接口**：使用OpenAI兼容的API格式
- **错误处理**：实现重试机制和降级策略
- **流式输出**：支持长文本的流式生成
- **Token管理**：监控使用量，避免超限

#### 数据格式标准
```javascript
// VL模型输出格式
interface VideoAnalysisResult {
  duration: number;
  keyframes: Array<{timestamp: string, description: string}>;
  scenes: Array<{type: string, startTime: string, endTime: string}>;
  objects: Array<{name: string, appearances: Array<{start: string, end: string}>}>;
  actions: Array<{action: string, startTime: string, endTime: string}>;
}

// 最终报告格式
interface AnalysisReport {
  videoInfo: {
    duration: string;
    format: string;
    size: string;
  };
  contentAnalysis: {
    keyframes: Array<{timestamp: string, analysis: string}>;
    scenes: Array<{category: string, description: string, duration: string}>;
    objects: Array<{name: string, significance: string, frequency: string}>;
    actions: Array<{description: string, sequence: string, significance: string}>;
  };
  technicalAnalysis: {
    emotionalTone: string;
    colorPalette: Array<{color: string, percentage: string}>;
    qualityAssessment: {
      clarity: number;
      stability: number;
      composition: number;
    };
  };
}
```

### 质量验收标准

#### 1. 内容准确性标准
- **时间精度**：所有时间戳误差不超过±2秒
- **识别准确率**：主要物体识别准确率≥80%，场景分类准确率≥75%
- **逻辑一致性**：分析结果之间无矛盾，符合视频实际内容

#### 2. 报告质量标准
- **结构完整性**：报告必须包含所有预定章节和要素
- **内容丰富性**：每个分析维度至少包含3个具体观察点
- **专业性**：使用专业术语，分析深度达到行业标准
- **可读性**：语言表达清晰，逻辑层次分明

#### 3. 融合方案标准
- **可行性**：提出的方案在技术上可执行
- **创新性**：提供至少3种不同的转场和创意方案
- **详细程度**：包含具体的时间轴和技术参数
- **叙事逻辑**：融合后的故事线合理且吸引人

#### 4. 音乐提示词标准
- **具体性**：包含明确的风格、乐器、节奏要求
- **可执行性**：提示词足够详细，AI模型可直接使用
- **创意性**：体现专业音乐制作水准
- **匹配度**：与视频内容和情感高度匹配

#### 5. 性能标准
- **响应时间**：单视频分析≤3分钟，融合方案≤5分钟
- **成功率**：API调用成功率≥95%
- **成本控制**：单次分析总Token消耗≤50K

### 风险 / 权衡

**风险1：模型协调复杂性**
- **影响**：开发复杂度增加，调试困难
- **缓解**：建立标准化的调用模板和错误处理机制

**风险2：成本控制**
- **影响**：双模型调用成本较高
- **缓解**：优化Prompt长度，合理设置max_tokens参数

**风险3：质量一致性**
- **影响**：不同模型输出风格可能不统一
- **缓解**：使用统一的风格模板和后处理规则

**风险4：API依赖**
- **影响**：外部服务稳定性影响系统可用性
- **缓解**：实现重试机制和缓存策略

### 迁移计划

**阶段1：基础架构搭建（1天）**
- 集成qwen-plus API调用
- 建立模型服务抽象层
- 实现基础的错误处理

**阶段2：提示词模板开发（0.5天）**
- 基于qwen3-prompt.md设计专业模板
- 测试和优化提示词效果
- 建立输出格式规范

**阶段3：集成测试（0.5天）**
- 端到端功能测试
- 性能基准测试
- 质量标准验证

### Open Questions

- qwen-plus与qwen3-vl的API调用配比如何优化？
- 是否需要引入中间缓存机制避免重复分析？
- 如何评估和监控输出质量的一致性？
- 在高并发场景下如何保证响应性能？